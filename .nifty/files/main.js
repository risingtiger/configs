import{Init as SwitchStationInit,Get_Lazyload_View_Url_Patterns}from'./alwaysload/switchstation.js';import'./thirdparty/lit-html.js';import'./alwaysload/fetchlassie.js';import{Init as LocalDBSyncInit}from'./alwaysload/localdbsync.js';import'./alwaysload/influxdb.js';import{Init as SSEInit,Close as SSEClose}from'./alwaysload/sse.js';import{init as loggerInit}from'./alwaysload/logger.js';import{Init as EngagementListenInit}from'./alwaysload/engagementlisten.js';import{Init as LazyLoadFilesInit}from"./alwaysload/lazyload_files.js";import{Init as DatahodlInit}from"./alwaysload/datahodl.js";import{Init as CMechInit}from'./alwaysload/cmech.js';import{Init as IDBInit}from'./alwaysload/indexeddb.js';import'./alwaysload/utils.js';const SETTINGS={"MAIN":{"INFO":{"localdb_objectstores":[{"name":"localdbsync_pending_sync_operations"},{"name":"pending_logs","auto_increment":true},{"name":"__deleted_docs"}]},"LAZYLOADS":[{"type":"view","urlmatch":"appmsgs","name":"appmsgs","is_instance":false,"dependencies":[],"auth":[]},{"type":"view","urlmatch":"login","name":"login","is_instance":false,"dependencies":[],"auth":[]},{"type":"view","urlmatch":"setup_push_allowance","name":"setup_push_allowance","is_instance":false,"dependencies":[{"type":"component","name":"ol"},{"type":"component","name":"btn"}],"auth":["admin","store_manager","scanner"]},{"type":"view","urlmatch":"testassist","name":"testassist","is_instance":false,"dependencies":[{"type":"component","name":"btn"}],"auth":["admin"]},{"type":"component","name":"graphing","is_instance":false,"dependencies":[{"type":"thirdparty","name":"chartist"}],"auth":[]},{"type":"component","name":"ol2","is_instance":false,"dependencies":[],"auth":[]},{"type":"component","name":"ol","is_instance":false,"dependencies":[],"auth":[]},{"type":"component","name":"pol","is_instance":false,"dependencies":[],"auth":[]},{"type":"component","name":"tl","is_instance":false,"dependencies":[],"auth":[]},{"type":"component","name":"reveal","is_instance":false,"dependencies":[],"auth":[]},{"type":"component","name":"dselect","is_instance":false,"dependencies":[],"auth":[]},{"type":"component","name":"in","is_instance":false,"dependencies":[{"type":"component","name":"dselect"},{"type":"component","name":"animeffect"}],"auth":[]},{"type":"component","name":"form2","is_instance":false,"dependencies":[],"auth":[]},{"type":"component","name":"in2","is_instance":false,"dependencies":[{"type":"component","name":"dselect"},{"type":"component","name":"animeffect"}],"auth":[]},{"type":"component","name":"animeffect","is_instance":false,"dependencies":[],"auth":[]},{"type":"component","name":"toast","is_instance":false,"dependencies":[],"auth":[]},{"type":"component","name":"btn","is_instance":false,"dependencies":[{"type":"component","name":"animeffect"}],"auth":[]},{"type":"thirdparty","name":"chartist","is_instance":false,"dependencies":[],"auth":[]},{"type":"lib","name":"testlib","is_instance":false,"dependencies":[],"auth":[]}]},"INSTANCE":{"INFO":{"name":"INSTANCE_NAME","shortname":"pwt","firebase":{"project":"purewatertech","identity_platform_key":"AIzaSyCdBd4FDBCZbL03_M4k2mLPaIdkUo32giI","dbversion":19},"localdb_objectstores":[{"name":"nada_for_now"}]},"LAZYLOADS":[{"type":"view","urlmatch":"home","name":"home","is_instance":true,"dependencies":[{"type":"component","name":"in2"},{"type":"component","name":"btn"},{"type":"component","name":"toast"}],"auth":[]},{"type":"view","urlmatch":"adminsyncfrommastercsv","name":"adminsyncfrommastercsv","is_instance":true,"dependencies":[{"type":"component","name":"in2"},{"type":"component","name":"btn"},{"type":"component","name":"toast"}],"auth":[]},{"type":"view","urlmatch":"machines","subs":[],"name":"machines","is_instance":true,"dependencies":[{"type":"component","name":"form2"},{"type":"component","name":"ol2"},{"type":"component","name":"pol"},{"type":"component","name":"in2"},{"type":"component","name":"dselect"},{"type":"component","name":"btn"},{"type":"component","name":"toast"},{"type":"component","name":"metersreport"},{"type":"component","name":"machinedetails"},{"type":"component","name":"machinemap"}],"auth":["user","admin","store_manager","scanner"]},{"type":"view","urlmatch":"machines/:id","subs":[],"name":"machine","is_instance":true,"dependencies":[{"type":"component","name":"ol"},{"type":"component","name":"ol2"},{"type":"component","name":"reveal"},{"type":"component","name":"in"},{"type":"component","name":"in2"},{"type":"component","name":"dselect"},{"type":"component","name":"btn"},{"type":"component","name":"toast"},{"type":"component","name":"metersreport"},{"type":"component","name":"machinedetails"},{"type":"component","name":"machinemap"}],"auth":["user","admin","store_manager","scanner"]},{"type":"view","urlmatch":"machines/:id/telemetry","name":"machinetelemetry","is_instance":true,"dependencies":[{"type":"component","name":"graphing"},{"type":"component","name":"ol"},{"type":"component","name":"toast"}],"auth":["user","admin","store_manager","scanner"]},{"type":"view","urlmatch":"notifications","name":"notifications","is_instance":true,"dependencies":[{"type":"component","name":"ol2"},{"type":"component","name":"btn"},{"type":"component","name":"in2"},{"type":"component","name":"in"},{"type":"component","name":"reveal"},{"type":"component","name":"toast"}],"auth":["user","admin","store_manager","scanner"]},{"type":"component","name":"metersreport","is_instance":true,"dependencies":[{"type":"component","name":"dselect"},{"type":"component","name":"btn"},{"type":"component","name":"in"},{"type":"component","name":"toast"}],"auth":[]},{"type":"component","name":"machinedetails","is_instance":true,"dependencies":[{"type":"component","name":"btn"},{"type":"component","name":"toast"}],"auth":[]},{"type":"component","name":"machinemap","is_instance":true,"dependencies":[{"type":"component","name":"btn"},{"type":"component","name":"toast"}],"auth":[]}]}};let _serviceworker_reg;window.addEventListener("load",async(_e)=>{const lazyloads=[...SETTINGS.MAIN.LAZYLOADS,...SETTINGS.INSTANCE.LAZYLOADS];const all_localdb_objectstores=[...SETTINGS.INSTANCE.INFO.localdb_objectstores,...SETTINGS.MAIN.INFO.localdb_objectstores];const lazyload_view_urlpatterns=Get_Lazyload_View_Url_Patterns(lazyloads);localStorage.setItem("identity_platform_key",SETTINGS.INSTANCE.INFO.firebase.identity_platform_key);if(window.APPVERSION>0){try{await setup_service_worker(lazyload_view_urlpatterns)}catch(err){alert("unable to load service worker");console.error("Service Worker setup failed:",err);return}}{IDBInit(all_localdb_objectstores,SETTINGS.INSTANCE.INFO.firebase.project,SETTINGS.INSTANCE.INFO.firebase.dbversion);EngagementListenInit();LocalDBSyncInit(SETTINGS.INSTANCE.INFO.localdb_objectstores,SETTINGS.INSTANCE.INFO.firebase.project,SETTINGS.INSTANCE.INFO.firebase.dbversion);DatahodlInit();CMechInit();loggerInit();LazyLoadFilesInit(lazyloads);await SwitchStationInit()}setTimeout(()=>SSEInit(),2500)});window.addEventListener('online',()=>{if(_serviceworker_reg?.active){_serviceworker_reg.active.postMessage({action:"networkchange",data:{state:'online'}})}});window.addEventListener('offline',()=>{if(_serviceworker_reg?.active){_serviceworker_reg.active.postMessage({action:"networkchange",data:{state:'offline'}})}});document.addEventListener('visibilitychange',()=>{if(_serviceworker_reg?.active){_serviceworker_reg.active.postMessage({action:"visibilitychange",is_visible:document.visibilityState==='visible'})}});let toast_id_counter=0;function ToastShow(msg,level='info',_duration){const toast_id=`maintoast-${toast_id_counter}`;const toast_el=document.createElement('c-toast');toast_el.id=toast_id;toast_el.setAttribute("msg",msg||"");toast_el.setAttribute("level",level?.toString()||'0');toast_el.setAttribute("duration",'2147483647');document.body.append(toast_el);toast_el.setAttribute("action","run");toast_el.addEventListener("click",()=>{if(toast_el.parentElement){toast_el.remove()}});toast_el.addEventListener("done",()=>{if(toast_el.parentElement){toast_el.remove()}});setTimeout(()=>{const toast_els=Array.from(document.querySelectorAll("c-toast"));let bottom_position=20;for(const el of toast_els){el.style.bottom=`${bottom_position}px`;bottom_position+=60}},10)}$N.ToastShow=ToastShow;function clickity(el){el.classList.add("clickity");const activeviewel=document.querySelector("#views > .view:last-child");const intrv=setInterval(()=>{const isactive=activeviewel.getAttribute("data-active")==="true";if(!isactive){el.classList.remove("clickity");clearInterval(intrv)}},100);setTimeout(()=>{el.classList.remove("clickity");clearInterval(intrv)},8000)}$N.Clickity=clickity;async function Unrecoverable(subj,msg,btnmsg,logsubj,logerrmsg,redirectionurl){const redirect=redirectionurl||`/v/appmsgs?logsubj=${logsubj}`;setalertbox(subj,msg,btnmsg,redirect);$N.Logger.log(40,logsubj,logerrmsg||"")}$N.Unrecoverable=Unrecoverable;async function GetConnectedState(){if(!_serviceworker_reg?.active)return'online';return new Promise((resolve)=>{const handler=(event)=>{if(event.data.action==='connectedstate'){navigator.serviceWorker.removeEventListener('message',handler);resolve(event.data.state)}};navigator.serviceWorker.addEventListener('message',handler);_serviceworker_reg.active.postMessage({action:'getconnectedstate'})})}$N.GetConnectedState=GetConnectedState;function setalertbox(subj,msg,btnmsg,redirect,clickHandler){const modal=document.getElementById('alert_notice');if(!modal)return;const isAlreadyActive=modal.classList.contains('active');if(!isAlreadyActive){modal.classList.add('active');const titleEl=document.getElementById('alert_notice_title');const btnReset=document.getElementById('alert_notice_btn');if(titleEl)titleEl.textContent=subj;if(btnReset){btnReset.textContent=btnmsg;const newBtnReset=btnReset.cloneNode(true);btnReset.parentNode?.replaceChild(newBtnReset,btnReset);newBtnReset.addEventListener('click',()=>{if(clickHandler){clickHandler()}else{window.location.href=redirect}})}}const msgContainer=document.getElementById('alert_notice_msg_container');if(msgContainer){const newMsgEl=document.createElement('p');newMsgEl.textContent=msg;msgContainer.appendChild(newMsgEl);msgContainer.scrollTop=msgContainer.scrollHeight}}const setup_service_worker=(lazyload_view_urlpatterns)=>new Promise((resolve,reject)=>{let hasPreviousController=navigator.serviceWorker.controller?true:false;navigator.serviceWorker.register('/sw.js').then((registration)=>{_serviceworker_reg=registration;navigator.serviceWorker.ready.then(()=>{registration.active?.postMessage({action:"initial_data_pass",id_token:localStorage.getItem("id_token"),token_expires_at:localStorage.getItem("token_expires_at"),refresh_token:localStorage.getItem("refresh_token"),user_email:localStorage.getItem("user_email"),lazyload_view_urlpatterns});resolve()}).catch((err)=>{reject(err)});navigator.serviceWorker.addEventListener('message',(event)=>{if(event.data.action==='update_auth_info'){localStorage.setItem("id_token",event.data.id_token);localStorage.setItem("token_expires_at",event.data.token_expires_at.toString());localStorage.setItem("refresh_token",event.data.refresh_token)}else if(event.data.action==='update_init'){SSEClose();setTimeout(()=>{if(_serviceworker_reg)_serviceworker_reg?.update()},300)}else if(event.data.action==='error_out'){if(event.data.subject==="sw4"){Unrecoverable("Not Authenticated","Please Login","Login","sw4",event.data.errmsg,"/v/login")}else{Unrecoverable("App Error",event.data.errmsg,"Restart App",event.data.subject,event.data.errmsg,null)}}else if(event.data.action==='backonline'){document.dispatchEvent(new Event('backonline'))}});navigator.serviceWorker.addEventListener('controllerchange',onNewServiceWorkerControllerChange);navigator.serviceWorker.addEventListener('updatefound',(_e)=>{SSEClose()});function onNewServiceWorkerControllerChange(){if(!hasPreviousController){hasPreviousController=true;return}const origin=window.location.origin;window.location.href="https://yavada.com/bouncebacktonifty.html?origin="+encodeURIComponent(origin)}}).catch((err)=>{reject(err)})})
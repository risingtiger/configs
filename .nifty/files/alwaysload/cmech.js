import{LoadViewData as DataHodlLoadViewData,PostLoadViewData as DataHodlPostLoadViewData,GetViewData as DataHodlGetViewData,GetViewPartData as DataHodlGetViewPartData,RemoveViewData as DataHodlRemoveViewData,LoadViewPartData as DataHodlLoadViewPartData,PostLoadViewPartData as DataHodlPostLoadViewPartData,RemoveViewPartData as DataHodlRemoveViewPartData,ReloadAllViewData as DataHodlReloadAllViewData}from'./datahodl.js';let _viewsel=document.body;let _postloadpromises;let _viewparts=new Map();const Init=()=>{_viewsel=document.getElementById("views");_viewsel.addEventListener("revealed",handle_revealed);$N.EngagementListen.Add_Listener(_viewsel,"cmech_view_resize_listener",["resize"],null,update_from_resize)};const AddView=(viewname,pathparams,searchparams,localdb_preload)=>new Promise(async(res,rej)=>{_viewparts.set(viewname,new Set());try{await DataHodlLoadViewData(viewname,pathparams,searchparams,localdb_preload)}catch{remove_view_aux(viewname);rej();return}const parentEl=document.querySelector("#views");parentEl.insertAdjacentHTML("beforeend",`<v-${viewname} class='view'></v-${viewname}>`);const viewcomponent=document.querySelector(`#views > v-${viewname}`);const d=DataHodlGetViewData(viewname);viewcomponent.ingest(d.loadeddata,d.pathparams,d.searchparams,'initial');viewcomponent.render();const shadow=viewcomponent.shadow;if(shadow.firstElementChild.tagName!=='LINK'){shadow.adoptedStyleSheets=[...shadow.adoptedStyleSheets,window.maincss]}try{await wait_for_all_render_and_hydration(viewname,viewcomponent)}catch{remove_view_aux(viewname);rej();return}if(viewcomponent.hydrated)viewcomponent.hydrated();res(1);_postloadpromises=[];_postloadpromises.push(DataHodlPostLoadViewData(viewname));for(const vp of[..._viewparts.get(viewname)]){const tagname=vp.tagName.toLowerCase().split("-")[1];_postloadpromises.push(DataHodlPostLoadViewPartData(viewname,tagname,vp.attributes))}});const RegisterView=(_component)=>{};const RegisterViewPart=async(component)=>{const tagname=component.tagName.toLowerCase();const tagname_split=tagname.split("-");if(tagname_split.length!==2)throw new Error("viewpart name can only contain one hyphen");const viewpartname=tagname_split[1];let vp_data=null;if(tagname_split[0]!=='vp')throw new Error("Not a view part component");for(const prop in component.a)component.a[prop]=component.getAttribute(prop);const ancestor_viewname=find_ancestor_viewname(component);component.viewname=ancestor_viewname;_viewparts.get(ancestor_viewname).add(component);try{vp_data=await DataHodlLoadViewPartData(ancestor_viewname,viewpartname,component.attributes)}catch(err){component.dispatchEvent(new Event('viewpartconnectfailed'));return}const vd=DataHodlGetViewData(ancestor_viewname);const vpd=DataHodlGetViewPartData(ancestor_viewname,`vp-${viewpartname}`);component.ingest(vpd?.loadeddata||vd.loadeddata,vd.pathparams,vd.searchparams,'initial');component.render();const shadow=component.shadow;if(shadow.firstElementChild.tagName!=='LINK'){shadow.adoptedStyleSheets=[...shadow.adoptedStyleSheets,window.maincss]}if(component.hydrated)component.hydrated();component.dispatchEvent(new Event('viewparthydrated'))};const PostLoadViewPart=async(component)=>{const tagname=component.tagName.toLowerCase();const tagname_split=tagname.split("-");const viewpartname=tagname_split[1];const ancestor_viewname=component.viewname;let postdata=null;try{postdata=await DataHodlPostLoadViewPartData(ancestor_viewname,viewpartname,component.attributes)}catch{$N.Unrecoverable('Post data fail',`Post data load failed for view ${viewpartname}`,'Reset App','cmp','Unable to Post Load',null);return false}if(!postdata)return false;const d=DataHodlGetViewData(ancestor_viewname);const vp_merged=DataHodlGetViewPartData(ancestor_viewname,viewpartname);component.ingest(vp_merged?.loadeddata||d.loadeddata,d.pathparams,d.searchparams,'postload');component.render();if(component.revealed)component.revealed();return true};const AttributeChangedCallback=(component,name,oldval,newval,_opts)=>new Promise((res)=>{if(oldval===null)return;const a=component.a;a[name]=newval;if(!a.updatescheduled){a.updatescheduled=true;Promise.resolve().then(()=>{a.updatescheduled=false;res()})}});const ViewDisconnectedCallback=(component)=>{remove_view_aux(component.tagName.toLowerCase().split("-")[1])};const ViewPartDisconnectedCallback=(component)=>{const tagname=component.tagName.toLowerCase();const viewpartname=tagname.split("-")[1];const ancestor_viewname=component.viewname;if(_viewparts.has(ancestor_viewname))_viewparts.get(ancestor_viewname).delete(component);DataHodlRemoveViewPartData(ancestor_viewname,viewpartname)};const UpdateView=(viewname,pathparams,searchparams,eventname)=>new Promise(async(res,rej)=>{const viewel=document.querySelector(`#views > v-${viewname}`);try{await DataHodlReloadAllViewData(viewname,pathparams,searchparams)}catch{remove_view_aux(viewname);rej();return}const d=DataHodlGetViewData(viewname);viewel.ingest(d.loadeddata,pathparams,searchparams,eventname);viewel.render();for(const subel of _viewparts.get(viewname)){const viewpartname=subel.tagName.toLowerCase().split("-")[1];const viewpartdata=DataHodlGetViewPartData(viewname,viewpartname);subel.ingest(viewpartdata?.loadeddata||d.loadeddata,pathparams,searchparams,eventname);subel.render()}res()});const GetViewParts=(viewname)=>{return _viewparts.get(viewname)};const find_ancestor_viewname=(component)=>{let current=component;while(true){const root=current.getRootNode();if(root===document)return null;const host=root.host;const tagname=host.tagName.toLowerCase();if(tagname.startsWith('v-'))return tagname.split('-')[1];current=host}};const wait_for_all_render_and_hydration=async(viewname,_viewcomponent)=>new Promise((res,rej)=>{let viewpart_hydrated_events_count=0;let failed=false;const viewparts_set=_viewparts.get(viewname);if(viewparts_set.size===0){res();return}const viewparthydrated=()=>{if(failed)return;viewpart_hydrated_events_count+=1;if(viewpart_hydrated_events_count<viewparts_set.size)return;for(const part of viewparts_set){part.removeEventListener("viewparthydrated",viewparthydrated);part.removeEventListener("viewpartconnectfailed",viewpartfailed)}res()};const viewpartfailed=()=>{failed=true;for(const part of viewparts_set){part.removeEventListener("viewparthydrated",viewparthydrated);part.removeEventListener("viewpartconnectfailed",viewpartfailed)}rej()};for(const part of viewparts_set){part.addEventListener("viewparthydrated",viewparthydrated);part.addEventListener("viewpartconnectfailed",viewpartfailed)}setTimeout(()=>{failed=true;for(const part of viewparts_set){part.removeEventListener("viewparthydrated",viewparthydrated);part.removeEventListener("viewpartconnectfailed",viewpartfailed)}rej()},15000)});const handle_revealed=async(ev)=>{const viewname=ev.detail.viewname;const viewel=document.querySelector(`#views > v-${viewname}`);let postfuncexists;try{postfuncexists=await Promise.all(_postloadpromises)}catch{$N.Unrecoverable('Post data fail',`Post data load failed for view ${viewname}`,'Reset App','cmp','Unable to Post Load',null);return}if(postfuncexists.some((v)=>v===true)){const d=DataHodlGetViewData(viewname);viewel.ingest(d.loadeddata,d.pathparams,d.searchparams,'postload');viewel.render();for(const subel of[..._viewparts.get(viewname)]){const viewpartdata=DataHodlGetViewPartData(viewname,subel.tagName.toLowerCase());subel.ingest(viewpartdata?.loadeddata||d.loadeddata,d.pathparams,d.searchparams,'postload');subel.render()}}for(const subel of[..._viewparts.get(viewname)]){if(subel.revealed)subel.revealed()}if(viewel.revealed)viewel.revealed()};const update_from_resize=()=>{const allviews=Array.from(_viewsel.children);for(const view of allviews){const viewname=view.tagName.toLowerCase().split("-")[1];for(const subel of[..._viewparts.get(viewname)]){subel.render()}view.render()}};const remove_view_aux=(viewname)=>{_viewparts.delete(viewname);_postloadpromises=[];DataHodlRemoveViewData(viewname)};export{Init,AddView,UpdateView,GetViewParts};if(!window.$N){window.$N={}}window.$N.CMech={RegisterView,RegisterViewPart,PostLoadViewPart,AttributeChangedCallback,ViewDisconnectedCallback,ViewPartDisconnectedCallback}
const PRELOAD_BASE_ASSETS=["/v/appmsgs","/v/login","/v/home","/"];const CONNECTEDSTATE_CHECK_TIMEOUT=5000;const PERIODIC_MAINTENANCE_INTERVAL=60*60*1000;const INITIAL_PERIODIC_MAINTENANCE_INTERVAL=15*1000;const DELAY_PRELOAD_BASE_ASSETS=10*1000;const EXITDELAY=9000;const BACKOFF_MAX=24;let _cache_name='cacheV__0__';let _cache_version=Number(_cache_name.split("__")[1]);let _id_token="";let _token_expires_at=0;let _refresh_token="";let _lazyload_view_urlpatterns=[];let _connectedstate=0;let _connectedcheck_timeout=0;let _backoff_multiplier=1;let _is_test_logging=true;const _client_visibility=new Map();self.addEventListener('install',(event)=>{event.waitUntil((async()=>{await self.skipWaiting()})())});self.addEventListener('activate',(event)=>{event.waitUntil((async()=>{const cacheKeys=await caches.keys();for(const key of cacheKeys){if(key!==_cache_name){await caches.delete(key)}}await self.clients.claim();setTimeout(()=>preload_base_assets_into_cache(PRELOAD_BASE_ASSETS),DELAY_PRELOAD_BASE_ASSETS)})())});self.addEventListener('controllerchange',(_e)=>{});self.addEventListener('fetch',(e)=>{let requesturltype=2;const pathname=new URL(e.request.url).pathname;if(pathname.startsWith("sse_add_listener")){return}if(pathname.startsWith('/v/')||pathname==='/'){requesturltype=2;e.respondWith(handle_file_call(e.request,pathname,requesturltype));return}if(pathname.startsWith('/assets/')||pathname.startsWith('/favicon.ico')||pathname.startsWith('/app.webmanifest')||pathname.startsWith('/shared_worker.js')){requesturltype=1;e.respondWith(handle_file_call(e.request,pathname,requesturltype));return}if(pathname.startsWith('/api/')){requesturltype=0;e.respondWith(handle_data_call(e.request));return}e.respondWith(new Promise(async(res,_rej)=>{try{const r=await fetch(e.request,{signal:AbortSignal.timeout(EXITDELAY)});res(r)}catch(err){set_connectedstate_offline('fetch call timeout');res(new Response(null,{status:503,statusText:'Network error'}))}}))});self.addEventListener('message',async(e)=>{if(e.data.action==="update"){self.registration?.update()}else if(e.data.action==="initial_data_pass"){_id_token=e.data.id_token;_token_expires_at=Number(e.data.token_expires_at);_refresh_token=e.data.refresh_token;_lazyload_view_urlpatterns=e.data.lazyload_view_urlpatterns;clearTimeout(_connectedcheck_timeout);setTimeout(()=>periodicmaintenance(),INITIAL_PERIODIC_MAINTENANCE_INTERVAL);connectedcheck()}else if(e.data.action==='networkchange'){clearTimeout(_connectedcheck_timeout);_connectedcheck_timeout=setTimeout(()=>{connectedcheck()},750)}else if(e.data.action==='set_test_logging_true'){_is_test_logging=true}else if(e.data.action==='visibilitychange'){const clientId=e.source?.id;if(!clientId)return;const was_any_focused=isAnyClientFocused();_client_visibility.set(clientId,e.data.is_visible);const is_any_focused=isAnyClientFocused();if(!was_any_focused&&is_any_focused){clearTimeout(_connectedcheck_timeout);connectedcheck()}}else if(e.data.action==='getconnectedstate'){e.source.postMessage({action:'connectedstate',state:_connectedstate===0?'online':'offline'})}});self.addEventListener('push',(e)=>{if(self.Notification.permission=='denied'){return}if(self.Notification.permission=='default'){}try{const msg=e.data.json().data;const options={body:msg.body};e.waitUntil(self.registration.showNotification(msg.title,options))}catch(err){throw new Error('Error in SW: '+err)}});self.addEventListener('notificationclick',(event)=>{event.waitUntil()});const handle_data_call=(r)=>new Promise(async(res,_rej)=>{const base_headers=new Headers(r.headers);const should_cache=base_headers.has('Nifty-Cache');const cache_api=should_cache?await caches.open(_cache_name):null;if(should_cache&&cache_api){const cached_response=await cache_api.match(r);if(cached_response){const keys=await cache_api.keys();const req=keys.find((k)=>k.url===r.url&&k.method===r.method&&k.headers.has('Nifty-Cache'));const cache_ts=req?.headers.get('Nifty-Cache')||null;const ts=cache_ts?Number(cache_ts):null;if(ts&&!isNaN(ts)){const nowts=Math.round(Date.now()/1000);if(nowts>ts){}else{const headers_with_flag=new Headers(cached_response.headers);headers_with_flag.set('Nifty-Is-Cache','true');const flagged_response=new Response(cached_response.body,{status:cached_response.status,statusText:cached_response.statusText,headers:headers_with_flag});res(flagged_response);return}}}}if(_connectedstate===1){res(new Response(null,{status:503,statusText:'Network error - App Offline',headers:new Headers()}));return}let ar;try{ar=await authrequest()}catch(err){if(err==="Network error"){set_connectedstate_offline('data call timeout');res(new Response(null,{status:503,statusText:'Network error',headers:new Headers()}));return}await error_out("sw4","authrequest failed during data call - "+err);res(new Response(null,{status:401,statusText:'Unauthorized',headers:new Headers()}));return}base_headers.append('versionofapp',_cache_version.toString());base_headers.append('Authorization',`Bearer ${_id_token}`);const network_request=new Request(r,{headers:base_headers,cache:'no-store',signal:AbortSignal.timeout(EXITDELAY)});let server_response;try{server_response=await fetch(network_request)}catch(err){set_connectedstate_offline('data call timeout');res(new Response(null,{status:503,statusText:'Network error',headers:new Headers()}));return}if(server_response.status===401){await error_out("sw4","");res(new Response(null,{status:401,statusText:'Unauthorized',headers:new Headers()}));return}if(server_response.headers.get('updatedrequired')){self.clients.matchAll().then((clients)=>{clients.forEach((client)=>{client.postMessage({action:'update_init'})})});res(new Response(null,{status:426,statusText:'updatedrequired',headers:new Headers()}));return}if(server_response.status===200&&should_cache&&cache_api){cache_api.put(network_request,server_response.clone())}res(server_response)});const handle_file_call=(nr,pathname,requesturltype)=>new Promise(async(res,_rej)=>{const viewname=requesturltype===2?get_view_name_from_url(pathname):null;const request_for_viewurl=viewname?new Request("/v/"+viewname):null;const cache=await caches.open(_cache_name);const match_r=await cache.match(request_for_viewurl||nr);if(match_r){res(match_r);return}if(_connectedstate===1){res(set_failed_file_response());return}let r;try{r=await fetch(nr,{signal:AbortSignal.timeout(EXITDELAY)})}catch(err){set_connectedstate_offline('file call timeout');res(set_failed_file_response());return}if(r.status!==200){res(set_failed_file_response());return}if(r.status===200&&should_url_be_cached(pathname)){cache.put(request_for_viewurl||nr,r.clone())}res(r)});const get_view_name_from_url=(pathname)=>{pathname=pathname.slice(3);for(const[viewname,pattern]of _lazyload_view_urlpatterns){const regex=new RegExp(pattern);if(regex.test(pathname))return viewname}return null};const set_failed_file_response=()=>{let headers={'Cache-Control':'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0'};const responsebody=`Unable to Load File`;const returnresponse=new Response(responsebody,{status:503,statusText:'Network error',headers});return returnresponse};function should_url_be_cached(pathname){if(pathname.includes(".webmanifest")||pathname.includes("/assets/")||pathname.includes("/v/")||pathname==="/"){return true}else if(pathname.endsWith(".js")){return true}else{return false}}const authrequest=()=>new Promise(async(res,rej)=>{if(!_id_token){await error_out("sw4","authrequest no token in browser storage");rej("No token in browser storage");return}if(Date.now()/1000>_token_expires_at-30){const body={refresh_token:_refresh_token};fetch('/api/refresh_auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),signal:AbortSignal.timeout(EXITDELAY)}).then(async(r)=>{let data=await r.json();if(data.error){await error_out("sw4","authrequest refresh failed - "+data.error.message);rej("Refresh failed")}else{_id_token=data.id_token;_refresh_token=data.refresh_token;_token_expires_at=Math.floor(Date.now()/1000)+Number(data.expires_in);self.clients.matchAll().then((clients)=>{clients.forEach((client)=>{client.postMessage({action:'update_auth_info',id_token:_id_token,refresh_token:_refresh_token,token_expires_at:_token_expires_at})})});res("ok")}}).catch(async(_err)=>{rej("Network error")})}else{res("ok")}});const error_out=(subject,errmsg="")=>new Promise((res,_rej)=>{self.clients.matchAll().then((clients)=>{clients.forEach((client)=>{client.postMessage({action:'error_out',subject,errmsg})})});res(1)});const isAnyClientFocused=()=>_client_visibility.size===0||[..._client_visibility.values()].some((v)=>v===true);const set_connectedstate_offline=(logmsg="set to offline")=>{_connectedstate=1;clearTimeout(_connectedcheck_timeout);_connectedcheck_timeout=setTimeout(()=>connectedcheck(),500);for_testing_log(logmsg)};const getBackoffTimeout=()=>CONNECTEDSTATE_CHECK_TIMEOUT*_backoff_multiplier;const incrementBackoff=()=>{_backoff_multiplier=Math.min(_backoff_multiplier+1,BACKOFF_MAX)};const resetBackoff=()=>{_backoff_multiplier=1};const connectedcheck=async()=>{const navigOn=self.navigator.onLine?true:false;const anyFocused=isAnyClientFocused();if(_connectedstate===0&&navigOn&&anyFocused){resetBackoff();_connectedcheck_timeout=setTimeout(()=>connectedcheck(),CONNECTEDSTATE_CHECK_TIMEOUT);return}if(_connectedstate===0&&navigOn&&!anyFocused){incrementBackoff();_connectedcheck_timeout=setTimeout(()=>connectedcheck(),getBackoffTimeout());return}if(_connectedstate===0&&!navigOn){_connectedstate=1;incrementBackoff();_connectedcheck_timeout=setTimeout(()=>connectedcheck(),getBackoffTimeout());return}if(_connectedstate===1&&!navigOn){incrementBackoff();_connectedcheck_timeout=setTimeout(()=>connectedcheck(),getBackoffTimeout());return}fetch('/api/ping',{signal:AbortSignal.timeout(3000)}).then((r)=>{if(r.status!==200){_connectedstate=1;incrementBackoff();_connectedcheck_timeout=setTimeout(()=>connectedcheck(),getBackoffTimeout());return}_connectedstate=0;if(isAnyClientFocused()){resetBackoff();_connectedcheck_timeout=setTimeout(()=>connectedcheck(),CONNECTEDSTATE_CHECK_TIMEOUT)}else{incrementBackoff();_connectedcheck_timeout=setTimeout(()=>connectedcheck(),getBackoffTimeout())}self.clients.matchAll().then((clients)=>{clients.forEach((client)=>{client.postMessage({action:'backonline'})})})}).catch(()=>{_connectedstate=1;incrementBackoff();_connectedcheck_timeout=setTimeout(()=>connectedcheck(),getBackoffTimeout())})};const periodicmaintenance=async()=>{const activeClients=await self.clients.matchAll();const activeIds=new Set(activeClients.map((c)=>c.id));for(const[id]of _client_visibility){if(!activeIds.has(id))_client_visibility.delete(id)}const now=Math.round(Date.now()/1000);let cache=await caches.open(_cache_name);const keys=await cache.keys();keys.forEach((req)=>{const tsstring=req.headers.get('Nifty-Cache');if(!tsstring)return;const ts=Number(tsstring);if(now>ts){cache.delete(req.url)}});setTimeout(()=>periodicmaintenance(),PERIODIC_MAINTENANCE_INTERVAL)};const preload_base_assets_into_cache=(assets)=>new Promise(async(res,_rej)=>{const cache=await caches.open(_cache_name);const promises=assets.map(async(url)=>{try{const cached_response=await cache.match(url);if(cached_response){return 1}const response=await fetch(url,{signal:AbortSignal.timeout(EXITDELAY)});if(response&&response.status===200){await cache.put(url,response.clone());return 1}return 0}catch(error){return 0}});Promise.all(promises).then(()=>{res(1)})});function for_testing_log(msg,secondarymsg=""){if(!_is_test_logging)return;if(!secondarymsg){console.debug(msg)}else{console.debug(msg,secondarymsg)}}export{}